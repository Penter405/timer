<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>魔方計時器</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans CJK TC', 'Helvetica Neue', Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #081426 100%);color:#e6eef6}
    .wrap{max-width:980px;margin:36px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}

    /* Timer */
    .timer{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
    .time{font-size:72px;font-weight:600;letter-spacing:2px;transition:color 0.2s}
    .ms{font-size:20px;display:inline-block;vertical-align:top;margin-left:8px;color:var(--muted)}
    .controls{margin-top:16px;display:flex;gap:8px}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:inherit;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#8b5cf6);color:#021124;border:none;font-weight:600}
    .small{padding:6px 8px;font-size:14px}

    /* Scramble */
    .scramble{font-family:monospace;background:#061022;padding:12px;border-radius:8px;margin-top:12px;color:#dbeafe}

    /* Right column */
    .stats{display:flex;flex-direction:column;gap:12px}
    .stat-row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:8px}

    /* History */
    .history{max-height:420px;overflow:auto;margin-top:12px}
    .time-item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .tags{display:flex;gap:6px}
    .tag{font-size:12px;padding:4px 6px;border-radius:6px;background:rgba(255,255,255,0.03)}

    footer{margin-top:18px;color:var(--muted);font-size:13px}

    @media(max-width:900px){.grid{grid-template-columns:1fr;}.time{font-size:56px}.wrap{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>魔方計時器</h1>
      <div style="margin-left:auto;color:var(--muted);font-size:13px">鍵盤：空白鍵開始/停止｜S 重新產生亂序｜I 開始檢查</div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="timer">
          <div id="inspection" style="color:var(--muted);font-size:14px">檢查：<span id="inspSec">-</span></div>
          <div style="height:8px"></div>
          <div class="time" id="display">00:00.00<span class="ms" id="ms"></span></div>
          <div class="controls">
            <button id="toggleInspection" class="small">開始檢查 (I)</button>
            <button id="newScramble" class="small">新亂序 (S)</button>
            <button id="startBtn" class="primary small">開始/停止 (Space)</button>
          </div>

          <div class="scramble" id="scramble">...</div>
          <div style="margin-top:10px;font-size:13px;color:var(--muted)">按下空白鍵或點擊 <strong>開始/停止</strong> 來計時。檢查時間 15 秒（可長按取消）。</div>
        </div>
      </div>

      <div class="card stats">
        <div class="stat-row"><div>最近時間</div><div id="last">-</div></div>
        <div class="stat-row"><div>平均 (Ao5)</div><div id="ao5">-</div></div>
        <div class="stat-row"><div>平均 (Ao12)</div><div id="ao12">-</div></div>
        <div class="stat-row"><div>最佳</div><div id="best">-</div></div>
        <div class="stat-row"><div>最差</div><div id="worst">-</div></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportCsv" class="small">匯出 CSV</button>
          <button id="clear" class="small">清除紀錄</button>
        </div>

        <div class="history" id="history"></div>
      </div>
    </div>

    <footer>儲存：使用 localStorage（僅本機）。亂序產生器為 3x3 常用步驟。歡迎回報想要的功能。</footer>
  </div>

  <script>
    // --- 工具 ---
    function fmt(ms){
      if(ms==null) return '-';
      const minutes = Math.floor(ms/60000);
      const seconds = Math.floor((ms%60000)/1000).toString().padStart(2,'0');
      const cent = Math.floor((ms%1000)/10).toString().padStart(2,'0');
      return minutes>0 ? `${minutes}:${seconds}.${cent}` : `${seconds}.${cent}`;
    }

    // --- 亂序產生器 ---
    const MOVES = ['U','D','L','R','F','B'];
    const SUFFIX = ['', "'", '2'];
    function genScramble(len=20){
      let res=[], prev=null;
      for(let i=0;i<len;i++){
        let m;
        do{ m = MOVES[Math.floor(Math.random()*MOVES.length)]; } while(m===prev);
        prev=m;
        res.push(m + SUFFIX[Math.floor(Math.random()*SUFFIX.length)]);
      }
      return res.join(' ');
    }

    // --- 存檔 ---
    const STORAGE_KEY = 'rubik_timer_sessions_v2';
    function loadTimes(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):[];}catch(e){return [];} }
    function saveTimes(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

    // --- 狀態 ---
    let times = loadTimes();
    let running=false, startAt=0, intervalId=null;
    let holdStart=null, ready=false, holding=false;
    let inspectionOn=false, inspectionTimer=null, inspectionSec=15;
    let inspectionHoldStart=null, inspectionHolding=false, inspectionReady=false;

    // --- 元件 ---
    const display = document.getElementById('display');
    const scrambleEl = document.getElementById('scramble');
    const inspEl = document.getElementById('inspSec');

    // --- 計時 ---
    function renderTime(ms){
      if(ms==null){ display.textContent='00:00.00'; return; }
      const minutes = Math.floor(ms/60000);
      const seconds = Math.floor((ms%60000)/1000).toString().padStart(2,'0');
      const cent = Math.floor((ms%1000)/10).toString().padStart(2,'0');
      display.textContent = minutes>0 ? `${minutes}:${seconds}.${cent}` : `${seconds}.${cent}`;
    }

    function startTimer(){
      if(!ready || running) return;
      running=true;
      startAt = Date.now();
      intervalId = setInterval(()=> renderTime(Date.now()-startAt),16);
      display.style.color='white';
      clearInterval(inspectionTimer);
      inspectionOn=false;
      inspEl.textContent='-';
    }

    function stopTimer(save=true){
      if(!running) return;
      running=false;
      clearInterval(intervalId);
      if(save) addTime(Date.now()-startAt);
      display.style.color='white';
    }

    function addTime(ms){
      times.unshift({
        ms: ms,
        at: new Date().toISOString(),
        scramble: scrambleEl.textContent
      });
      saveTimes(times);
      renderStats();
      newScramble();
      resetInspection();
    }

    function renderStats(){
      const historyEl = document.getElementById('history');
      const lastEl = document.getElementById('last');
      const ao5El = document.getElementById('ao5');
      const ao12El = document.getElementById('ao12');
      const bestEl = document.getElementById('best');
      const worstEl = document.getElementById('worst');

      historyEl.innerHTML='';
      times.forEach(t=>{
        const div = document.createElement('div');
        div.className='time-item';
        div.innerHTML=`<div style="font-weight:600">${fmt(t.ms)}</div>`;
        historyEl.appendChild(div);
      });

      lastEl.textContent = times.length?fmt(times[0].ms):'-';
      ao5El.textContent = times.length>=5?fmt(wcaAverage(times.slice(0,5).map(x=>x.ms))):'-';
      ao12El.textContent = times.length>=12?fmt(wcaAverage(times.slice(0,12).map(x=>x.ms))):'-';
      bestEl.textContent = times.length?fmt(Math.min(...times.map(x=>x.ms))):'-';
      worstEl.textContent = times.length?fmt(Math.max(...times.map(x=>x.ms))):'-';
    }

    function avg(arr){ return Math.round(arr.reduce((a,b)=>a+b,0)/arr.length); }
    function wcaAverage(arr){
      if(arr.length<3) return null;
      const sorted=[...arr].sort((a,b)=>a-b);
      sorted.shift();
      sorted.pop();
      return Math.round(sorted.reduce((a,b)=>a+b,0)/sorted.length);
    }
    function newScramble(){ scrambleEl.textContent = genScramble(20); }

    // --- 長按計時 ---
    function beginHold(){
      if(running){ stopTimer(); return; }
      holding=true; ready=false;
      holdStart=Date.now();
      display.style.color='red';
      setTimeout(()=>{
        if(holding){ ready=true; display.style.color='lime'; }
      },1000);
    }

    function endHold(){
      if(holding){
        holding=false;
        if(ready) startTimer();
        else display.style.color='white';
      }
    }

    // --- 空白鍵 ---
    let spaceHeld=false;
    document.addEventListener('keydown', e=>{
      if(e.code==='Space'){ e.preventDefault(); if(!spaceHeld){spaceHeld=true; beginHold();} }
      if(e.code==='KeyI'){ e.preventDefault(); startInspection(); }
      if(e.code==='KeyS'){ e.preventDefault(); newScramble(); renderTime(null); resetInspection(); }
    });
    document.addEventListener('keyup', e=>{
      if(e.code==='Space'){ e.preventDefault(); if(spaceHeld){spaceHeld=false; endHold();} }
    });

    // --- 按鈕事件 ---
    const startBtn = document.getElementById('startBtn');
    startBtn.addEventListener('mousedown', beginHold);
    startBtn.addEventListener('mouseup', endHold);
    startBtn.addEventListener('touchstart', e=>{ e.preventDefault(); beginHold(); });
    startBtn.addEventListener('touchend', e=>{ e.preventDefault(); endHold(); });

    document.getElementById('newScramble').addEventListener('click', ()=>{
      newScramble(); renderTime(null); resetInspection();
    });

    // --- 檢查功能 ---
    function resetInspection(){
      inspectionOn=false;
      clearInterval(inspectionTimer);
      inspEl.textContent='-';
      inspectionHolding=false;
      inspectionReady=false;
    }

    function startInspection(){
      if(running) return;
      if(inspectionOn && !inspectionReady){
        // 短按紅色警告，無重置
        display.style.color='red';
        return;
      }
      inspectionOn=true;
      inspectionSec=15;
      inspEl.textContent=inspectionSec;
      display.style.color='white';

      inspectionTimer = setInterval(()=>{
        inspectionSec--;
        inspEl.textContent=inspectionSec;
        if(inspectionSec<=0){
          clearInterval(inspectionTimer);
          inspectionOn=false;
          newScramble();
          renderTime(null);
          display.style.color='white';
        }
      },1000);
    }

    // --- 長按取消檢查 ---
    const toggleInspectionBtn = document.getElementById('toggleInspection');
    toggleInspectionBtn.addEventListener('mousedown', startInspectionHold);
    toggleInspectionBtn.addEventListener('mouseup', endInspectionHold);
    toggleInspectionBtn.addEventListener('touchstart', e=>{ e.preventDefault(); startInspectionHold(); });
    toggleInspectionBtn.addEventListener('touchend', e=>{ e.preventDefault(); endInspectionHold(); });

    function startInspectionHold(){
      if(!inspectionOn) return;
      inspectionHolding=true;
      inspectionReady=false;
      inspectionHoldStart=Date.now();
      setTimeout(()=>{
        if(inspectionHolding){
          inspectionReady=true;
          resetInspection();
        }
      },1000);
    }

    function endInspectionHold(){
      inspectionHolding=false;
      if(inspectionReady) resetInspection();
    }

    // --- 匯出 CSV ---
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      if(!times.length) return;
      let csv = "時間(ms),記錄時間,亂序\n";
      times.forEach(t=>{ csv+=`${t.ms},${t.at},${t.scramble}\n`; });
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url;
      a.download='rubik_times.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // --- 清除 ---
    document.getElementById('clear').addEventListener('click', ()=>{
      times=[]; saveTimes(times); renderStats(); renderTime(null); resetInspection();
    });

    newScramble(); renderStats();
  </script>
</body>
</html>
